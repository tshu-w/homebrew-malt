name: Autobump

on:
  schedule:
    - cron: '0 10 * * *'  # Run daily at 10:00 UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  autobump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Check for updates
        id: check
        run: |
          FORMULA="Formula/pi-mono.rb"
          CURRENT_VERSION=$(grep -oE 'version "[^"]+"' "$FORMULA" | head -1 | sed 's/version "//;s/"$//')
          echo "Current version: $CURRENT_VERSION"

          # Get latest release from GitHub API
          LATEST=$(curl -sL https://api.github.com/repos/badlogic/pi-mono/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "Latest version: $LATEST"

          if [ "$CURRENT_VERSION" = "$LATEST" ]; then
            echo "Already up to date"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "New version available: $LATEST"
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Update formula
        if: steps.check.outputs.updated == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          FORMULA="Formula/pi-mono.rb"

          # Update version
          sed -i "s/version \"[^\"]*\"/version \"$VERSION\"/" "$FORMULA"

          # Update URLs
          sed -i "s|/v[0-9]\+\.[0-9]\+\.[0-9]\+/|/v$VERSION/|g" "$FORMULA"

          # Download and calculate new checksums for each platform
          declare -A SHAS
          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            URL="https://github.com/badlogic/pi-mono/releases/download/v${VERSION}/pi-${platform}.tar.gz"
            SHA=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)
            SHAS[$platform]=$SHA
            echo "${platform}: ${SHA}"
          done

          # Update sha256 values using Python for reliability
          python3 << PYEOF
          import re

          sha_map = {
              'darwin-arm64': '${SHAS[darwin-arm64]}',
              'darwin-x64': '${SHAS[darwin-x64]}',
              'linux-arm64': '${SHAS[linux-arm64]}',
              'linux-x64': '${SHAS[linux-x64]}'
          }

          with open('$FORMULA', 'r') as f:
              content = f.read()

          # Update sha256 for each platform
          for platform, sha in sha_map.items():
              pattern = rf'(url "https://github\.com/badlogic/pi-mono/releases/download/v{re.escape("$VERSION")}/pi-{re.escape(platform)}\.tar\.gz"\s+sha256 ")[^"]+"'
              replacement = rf'\g<1>{sha}"'
              content = re.sub(pattern, replacement, content)

          with open('$FORMULA', 'w') as f:
              f.write(content)

          print("Formula updated successfully")
          PYEOF

      - name: Commit and push
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/pi-mono.rb
          git diff --cached --quiet || (git commit -m "pi-mono: bump to ${{ steps.check.outputs.version }}" && git push)
