name: Autobump

on:
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  autobump:
    runs-on: ubuntu-latest
    env:
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Set up Homebrew tap
        run: |
          tap_dir="$(brew --repo)/Library/Taps/tshu-w"
          mkdir -p "$tap_dir"
          ln -s "$GITHUB_WORKSPACE" "$tap_dir/homebrew-malt"

      - name: Bump pi-mono
        run: |
          FORMULA="Formula/pi-mono.rb"
          CURRENT=$(grep -oP 'version "\K[^"]+' "$FORMULA" | head -1)
          LATEST=$(brew livecheck --json --formula tshu-w/malt/pi-mono 2>/dev/null \
            | jq -r '.[0].version.latest // empty')

          if [ -z "$LATEST" ] || [ "$CURRENT" = "$LATEST" ]; then
            echo "pi-mono: up to date ($CURRENT)"
            exit 0
          fi
          echo "pi-mono: $CURRENT -> $LATEST"

          declare -A SHAS
          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            url="https://github.com/badlogic/pi-mono/releases/download/v${LATEST}/pi-${platform}.tar.gz"
            sha=$(curl -fsSL "$url" | sha256sum | cut -d' ' -f1)
            SHAS[$platform]=$sha
            echo "  $platform: $sha"
          done

          python3 <<PYEOF
          import re

          with open("$FORMULA") as f:
              content = f.read()

          content = content.replace('version "$CURRENT"', 'version "$LATEST"')
          content = content.replace("/v$CURRENT/", "/v$LATEST/")

          shas = {
              "darwin-arm64": "${SHAS[darwin-arm64]}",
              "darwin-x64":   "${SHAS[darwin-x64]}",
              "linux-arm64":  "${SHAS[linux-arm64]}",
              "linux-x64":    "${SHAS[linux-x64]}",
          }
          for platform, sha in shas.items():
              pattern = (
                  r'(url "https://github\.com/badlogic/pi-mono/releases/download/'
                  r'v' + re.escape("$LATEST") + r'/pi-' + re.escape(platform)
                  + r'\.tar\.gz"\s+sha256 ")[^"]+"'
              )
              content = re.sub(pattern, rf'\g<1>{sha}"', content)

          with open("$FORMULA", "w") as f:
              f.write(content)
          PYEOF

          git add "$FORMULA"
          git diff --cached --quiet || git commit -m "pi-mono: bump to $LATEST"

      - name: Bump fcitx-remote-for-osx
        run: |
          FORMULA="Formula/fcitx-remote-for-osx.rb"
          CURRENT=$(grep -oP '/tags/\K[^"]+(?=\.tar\.gz")' "$FORMULA" | head -1)
          LATEST=$(brew livecheck --json --formula tshu-w/malt/fcitx-remote-for-osx 2>/dev/null \
            | jq -r '.[0].version.latest // empty')

          if [ -z "$LATEST" ] || [ "$CURRENT" = "$LATEST" ]; then
            echo "fcitx-remote-for-osx: up to date ($CURRENT)"
            exit 0
          fi
          echo "fcitx-remote-for-osx: $CURRENT -> $LATEST"

          url="https://github.com/xcodebuild/fcitx-remote-for-osx/archive/refs/tags/${LATEST}.tar.gz"
          sha=$(curl -fsSL "$url" | sha256sum | cut -d' ' -f1)
          echo "  sha256: $sha"

          sed -i "s|/tags/${CURRENT}.tar.gz|/tags/${LATEST}.tar.gz|" "$FORMULA"
          sed -i "s/sha256 \"[^\"]*\"/sha256 \"${sha}\"/" "$FORMULA"

          git add "$FORMULA"
          git diff --cached --quiet || git commit -m "fcitx-remote-for-osx: bump to $LATEST"

      - name: Bump ossutil
        run: |
          FORMULA="Formula/ossutil.rb"
          CURRENT=$(grep -oP 'version "\K[^"]+' "$FORMULA" | head -1)
          LATEST=$(brew livecheck --json --formula tshu-w/malt/ossutil 2>/dev/null \
            | jq -r '.[0].version.latest // empty')

          if [ -z "$LATEST" ] || [ "$CURRENT" = "$LATEST" ]; then
            echo "ossutil: up to date ($CURRENT)"
            exit 0
          fi
          echo "ossutil: $CURRENT -> $LATEST"

          declare -A SHAS
          for combo in mac-amd64 mac-arm64 linux-amd64 linux-arm64; do
            url="https://gosspublic.alicdn.com/ossutil/v2/${LATEST}/ossutil-${LATEST}-${combo}.zip"
            sha=$(curl -fsSL "$url" | sha256sum | cut -d' ' -f1)
            SHAS[$combo]=$sha
            echo "  $combo: $sha"
          done

          python3 <<PYEOF
          import re

          with open("$FORMULA") as f:
              content = f.read()

          # Replace all occurrences of old version (safe: dots can't appear in hex sha256)
          content = content.replace("$CURRENT", "$LATEST")

          shas = {
              "mac-amd64":   "${SHAS[mac-amd64]}",
              "mac-arm64":   "${SHAS[mac-arm64]}",
              "linux-amd64": "${SHAS[linux-amd64]}",
              "linux-arm64": "${SHAS[linux-arm64]}",
          }
          for combo, sha in shas.items():
              pattern = (
                  r'(url "https://gosspublic\.alicdn\.com/ossutil/v2/'
                  + re.escape("$LATEST") + r'/ossutil-' + re.escape("$LATEST")
                  + r'-' + re.escape(combo) + r'\.zip"\s+sha256 ")[^"]+"'
              )
              content = re.sub(pattern, rf'\g<1>{sha}"', content)

          with open("$FORMULA", "w") as f:
              f.write(content)
          PYEOF

          git add "$FORMULA"
          git diff --cached --quiet || git commit -m "ossutil: bump to $LATEST"

      - name: Push changes
        run: git push origin main
